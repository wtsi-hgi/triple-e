#!/bin/bash

# Triple-E: Docker and Boot2Docker wrapper scripts

# Christopher Harrison
# Human Genetics Informatics, Wellcome Trust Sanger Institute

# GPL3

read -r -d "" USAGE <<EOF
Usage: 3e [command]

Commands:
  ahoy     Start Docker host (if not already running)
  avast    Stop Docker host
  yarr     Display the Docker host status and list running containers
  scuttle  Stop and remove all running containers and remove all images
EOF

DHOST=boot2docker
DOCKER=docker

# Simple command "try...catch" block
function cmdTry {
  TEXT=$1
  CMD=$2

  # Run $CMD but pipe all output to /dev/null
  # Print $TEXT... followed with "Done" or "Failed!" appropriately
  # Exit on failure
  echo -n "$TEXT... "
  $CMD &>/dev/null && echo "Done" \
                   || { echo "Failed!"; exit 1; }
}

# Docker host status
function hostStatus {
  $DHOST status
}

# Running status of Docker host
function isAfloat {
  if [ $(hostStatus) == "running" ]; then
    return 0
  else
    return 1
  fi
}

# Start Docker host
function fullAhead {
  if isAfloat; then
    DHOST_IP=$($DHOST ip 2>/dev/null)
    echo "Docker host afloat on $DHOST_IP"
  else
    cmdTry "Launching Docker host" "$DHOST start"
    fullAhead
  fi
}

# Stop Docker host
function allStop {
  if isAfloat; then
    $($DHOST stop) && echo "Docker host in dry dock"
  fi
}

# Stop and remove all running containers and remove all images
function walkThePlank {
  if isAfloat; then
    PS=$($DOCKER ps -a -q)
    IMG=$($DOCKER images -q)

    if [ -n "$PS" ]; then
      cmdTry "Stopping all running containers" "$DOCKER stop $PS"
      cmdTry "Removing all containers" "$DOCKER rm $PS"
    fi

    if [ -n "$IMG" ]; then
      cmdTry "Removing all images" "$DOCKER rmi $IMG"
    fi
  fi
}

# Docker host and container status
function steadyAsSheGoes {
  echo "The Docker host be \"$(hostStatus)\""

  if isAfloat; then
    PS=$($DOCKER ps -q)
    
    if [ -n "$PS" ]; then
      echo 
      $DOCKER ps
    else
      # i.e., No running containers
      echo "...yet she be the Mary Celeste"
    fi
  fi
}

# Command line option delegation
function main {
  ARGV=$1

  case $ARGV in
    "ahoy")
      fullAhead
      ;;
    "avast")
      allStop
      ;;
    "scuttle")
      walkThePlank
      ;;
    "yarr")
      # A somewhat conspicuous Easter Egg!
      if [ $(date "+%m%d") == "0919" ]; then
        echo "Hahaarr, matey! Ye be a scurvy dog!"
      fi
      steadyAsSheGoes
      ;;
    *)
      echo "$USAGE"
      ;;
  esac
}

main $1
